library(shiny)
library(shinydashboard)
library(ggplot2)
library(caret)
library(corrplot)
library(shinycssloaders)
library(randomForest)
library(e1071)
library(xgboost)
library(dplyr)

ui <- dashboardPage(
  skin = "blue",
  dashboardHeader(title = "Auto ML â€“ RF vs SVM vs XGBoost"),
  
  dashboardSidebar(
    sidebarMenu(
      menuItem("Upload Data", tabName="upload", icon=icon("upload")),
      menuItem("Summary", tabName="summary", icon=icon("table")),
      menuItem("Visualizations", tabName="visual", icon=icon("chart-bar")),
      menuItem("Train Model", tabName="model", icon=icon("brain")),
      menuItem("Performance", tabName="performance", icon=icon("chart-line")),
      menuItem("Predict", tabName="predict", icon=icon("magic"))
    )
  ),
  
  dashboardBody(
    tabItems(
      
      tabItem(tabName="upload",
              h2("ðŸ“‚ Upload CSV File"),
              fileInput("file", "Choose CSV", accept=".csv"),
              tableOutput("head")),
      
      tabItem(tabName="summary",
              h2("ðŸ“Š Summary"),
              withSpinner(verbatimTextOutput("summary"), color="#1976D2")),
      
      tabItem(tabName="visual",
              h2("ðŸ“ˆ Visualizations"),
              uiOutput("colSelect"),
              uiOutput("scatterSelect"),
              uiOutput("pieSelect"),
              
              fluidRow(
                box(width=6, title="Histogram", withSpinner(plotOutput("histPlot"), color="#E91E63")),
                box(width=6, title="Correlation Heatmap", withSpinner(plotOutput("corrPlot"), color="#1565C0"))
              ),
              
              fluidRow(
                box(width=6, title="Scatter Plot", withSpinner(plotOutput("scatterPlot"), color="#4CAF50")),
                box(width=6, title="Pie Chart", withSpinner(plotOutput("pieChart"), color="#FF9800"))
              )
      ),
      
      tabItem(tabName="model",
              h2("ðŸ§  Train Models"),
              uiOutput("targetSelect"),
              sliderInput("split", "Train/Test Split:", min=.5, max=.9, value=.7),
              actionButton("trainBtn", "Train All Models", class="btn btn-success"),
              verbatimTextOutput("trainStatus")
      ),
      
      tabItem(tabName="performance",
              h2("ðŸ“Œ Model Comparison"),
              verbatimTextOutput("metrics"),
              plotOutput("comparePlot"),
              plotOutput("featurePlot")),
      
      tabItem(tabName="predict",
              h2("ðŸ”® Predict Output"),
              uiOutput("predictionInputs"),
              actionButton("predictBtn", "Predict", class="btn btn-primary"),
              h3(textOutput("predOutput"))
      )
    )
  )
)

server <- function(input, output) {
  
  # âœ… Load CSV
  data <- reactive({
    req(input$file)
    read.csv(input$file$datapath)
  })
  
  output$head <- renderTable({ head(data()) })
  output$summary <- renderPrint({ summary(data()) })
  
  # âœ… Visualization selectors
  output$colSelect <- renderUI({
    req(data())
    numericCols <- names(data()[, sapply(data(), is.numeric)])
    selectInput("histCol", "Column for Histogram:", numericCols)
  })
  
  output$scatterSelect <- renderUI({
    req(data())
    numericCols <- names(data()[, sapply(data(), is.numeric)])
    tagList(
      selectInput("scatterX", "Scatter X-Axis:", numericCols),
      selectInput("scatterY", "Scatter Y-Axis:", numericCols)
    )
  })
  
  output$pieSelect <- renderUI({
    req(data())
    catCols <- names(data()[, sapply(data(), function(x) is.factor(x) || is.character(x))])
    if(length(catCols)==0) return(NULL)
    selectInput("pieCol", "Column for Pie Chart:", catCols)
  })
  
  # âœ… Histogram
  output$histPlot <- renderPlot({
    req(input$histCol)
    ggplot(data(), aes_string(input$histCol)) +
      geom_histogram(fill="blue", color="white") + theme_minimal()
  })
  
  # âœ… Scatter
  output$scatterPlot <- renderPlot({
    req(input$scatterX, input$scatterY)
    ggplot(data(), aes_string(input$scatterX, input$scatterY)) +
      geom_point(color="red", size=3, alpha=0.7) +
      theme_minimal()
  })
  
  # âœ… Pie Chart
  output$pieChart <- renderPlot({
    req(input$pieCol)
    df <- data()
    df[[input$pieCol]] <- as.factor(df[[input$pieCol]])
    
    pieData <- df %>% count(.data[[input$pieCol]])
    
    ggplot(pieData, aes(x="", y=n, fill=.data[[input$pieCol]])) +
      geom_bar(stat="identity", width=1) +
      coord_polar("y") +
      theme_void() +
      labs(fill=input$pieCol, title=paste("Pie Chart of", input$pieCol))
  })
  
  # âœ… Correlation
  output$corrPlot <- renderPlot({
    numData <- data()[, sapply(data(), is.numeric)]
    if(ncol(numData)>1) corrplot(cor(numData), method="color")
  })
  
  # âœ… Target selector
  output$targetSelect <- renderUI({
    req(data())
    selectInput("target", "Select Target Column:", names(data()))
  })
  
  models <- reactiveVal(NULL)
  metrics_data <- reactiveVal(NULL)
  best_model <- reactiveVal(NULL)
  model_type <- reactiveVal(NULL)
  predict_cols <- reactiveVal(NULL)
  feature_imp <- reactiveVal(NULL)
  
  # âœ… Train Models
  observeEvent(input$trainBtn, {
    df <- data()
    target <- input$target
    features <- setdiff(names(df), target)
    
    # âœ… Convert chars to factors
    df <- df %>% mutate_if(is.character, as.factor)
    
    # âœ… Impute numeric missing
    df <- df %>% mutate_if(is.numeric, ~replace(., is.na(.), mean(., na.rm=TRUE)))
    
    # âœ… Impute factor missing
    df <- df %>% mutate_if(is.factor, ~replace(., is.na(.), names(which.max(table(.)))))
    
    # âœ… One-hot encode features
    dummies <- dummyVars(~ ., data=df[, features], fullRank=TRUE)
    encoded <- as.data.frame(predict(dummies, df[,features]))
    
    final <- cbind(encoded, target=df[[target]])
    
    # âœ… Detect type
    if(is.numeric(final$target) && length(unique(final$target))>10){
      model_type("Regression")
    } else {
      final$target <- as.factor(final$target)
      model_type("Classification")
    }
    
    set.seed(123)
    idx <- createDataPartition(final$target, p=input$split, list=FALSE)
    train <- final[idx,]; test <- final[-idx,]
    
    results <- list()
    
    # âœ… Random Forest
    rf_model <- randomForest(target ~ ., data=train, ntree=200, importance=TRUE)
    rf_pred <- predict(rf_model, test)
    
    # âœ… SVM
    svm_model <- svm(target ~ ., data=train)
    svm_pred <- predict(svm_model, test)
    
    # âœ… XGBoost
    trainX <- as.matrix(train[, setdiff(names(train),"target")])
    testX  <- as.matrix(test[, setdiff(names(test),"target")])
    
    if(model_type()=="Classification"){
      trainY <- as.numeric(train$target) - 1
      xgb_model <- xgboost(data=trainX, label=trainY, nrounds=100,
                           objective="binary:logistic", verbose=0)
      xgb_pred <- ifelse(predict(xgb_model, testX)>0.5, 1, 0)
      xgb_pred <- factor(xgb_pred, labels=levels(final$target))
    } else {
      trainY <- train$target
      xgb_model <- xgboost(data=trainX, label=trainY, nrounds=100,
                           objective="reg:squarederror", verbose=0)
      xgb_pred <- predict(xgb_model, testX)
    }
    
    # âœ… Compare
    if(model_type()=="Classification"){
      results$RandomForest <- mean(rf_pred == test$target)
      results$SVM <- mean(svm_pred == test$target)
      results$XGBoost <- mean(xgb_pred == test$target)
      best <- names(which.max(results))
    } else {
      results$RandomForest <- RMSE(as.numeric(rf_pred), test$target)
      results$SVM <- RMSE(as.numeric(svm_pred), test$target)
      results$XGBoost <- RMSE(as.numeric(xgb_pred), test$target)
      best <- names(which.min(results))
    }
    
    metrics_data(results)
    best_model(best)
    models(list(rf=rf_model, svm=svm_model, xgb=xgb_model, type=model_type()))
    predict_cols(names(encoded))
    feature_imp(importance(rf_model))
    
    output$trainStatus <- renderPrint({
      cat("âœ… Models Trained: Random Forest, SVM, XGBoost\nâœ… Best Model:", best)
    })
  })
  
  # âœ… Comparison Plot
  output$comparePlot <- renderPlot({
    req(metrics_data())
    df <- data.frame(
      Model=c("Random Forest","SVM","XGBoost"),
      Score=unlist(metrics_data())
    )
    
    ggplot(df, aes(x=Model, y=Score, fill=Model)) +
      geom_bar(stat="identity") + theme_minimal() +
      labs(title="Model Comparison") +
      scale_fill_manual(values=c("blue","purple","green"))
  })
  
  # âœ… Feature Importance
  output$featurePlot <- renderPlot({
    req(feature_imp())
    imp <- data.frame(Feature=rownames(feature_imp()), Importance=feature_imp()[,1])
    ggplot(imp, aes(x=reorder(Feature, Importance), y=Importance)) +
      geom_bar(stat="identity", fill="darkred") +
      coord_flip() +
      labs(title="Random Forest Feature Importance") +
      theme_minimal()
  })
  
  # âœ… Prediction Inputs
  output$predictionInputs <- renderUI({
    req(predict_cols())
    lapply(predict_cols(), function(col){
      numericInput(col, paste("Enter", col, ":"), value=0)
    })
  })
  
  # âœ… Predict using best model
  observeEvent(input$predictBtn, {
    req(models(), best_model())
    
    newData <- data.frame(matrix(ncol=length(predict_cols()), nrow=1))
    names(newData) <- predict_cols()
    for(col in predict_cols()) newData[[col]] <- input[[col]]
    
    best <- best_model()
    modelList <- models()
    
    if(best=="RandomForest"){ pred <- predict(modelList$rf, newData) }
    if(best=="SVM"){ pred <- predict(modelList$svm, newData) }
    if(best=="XGBoost"){
      pred <- predict(modelList$xgb, as.matrix(newData))
      if(modelList$type=="Classification") pred <- ifelse(pred>0.5,1,0)
    }
    
    output$predOutput <- renderText({ paste("âœ… Prediction:", pred) })
  })
}

shinyApp(ui, server)
